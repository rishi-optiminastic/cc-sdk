var CarbonCut=function(){"use strict";function e(){if("undefined"==typeof window)return null;return new URLSearchParams(window.location.search).get("cc_tracker")}class t{constructor(){this.defaults={trackerToken:null,apiUrl:"http://127.0.0.1:8000/api/v1/events/",sessionId:null,pingInterval:15e3,debug:!1,autoTrack:!0,respectDoNotTrack:!0,maxRetries:3,retryDelay:1e3,domain:null,enableGeolocation:!1,requestLocation:!1,geolocationTimeout:1e4,geolocationHighAccuracy:!1,autoRequestLocation:!0,promptForLocationOnLoad:!0},this.config={...this.defaults}}init(t={}){return this.config={...this.defaults,...t,trackerToken:t.trackerToken||e()},this.validate()}validate(){return this.config.trackerToken?!!this.config.apiUrl||(console.error("CarbonCut: API URL is required"),!1):(console.error('CarbonCut: No tracker token provided. Add data-token="YOUR_TOKEN" to script tag.'),!1)}get(e){return this.config[e]}set(e,t){this.config[e]=t}getAll(){return{...this.config}}}class i{constructor(){this.state={isInitialized:!1,timeSpent:0,lastPath:null,retryCount:0}}get(e){return this.state[e]}set(e,t){this.state[e]=t}incrementTimeSpent(e){this.state.timeSpent+=e}reset(){this.state={isInitialized:!1,timeSpent:0,lastPath:null,retryCount:0}}getAll(){return{...this.state}}}class n{constructor(e,t){this.config=e,this.logger=t,this.sessionId=null}start(){return this.sessionId="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),this.config.set("sessionId",this.sessionId),"undefined"!=typeof window&&(window.__CC_SESSION_ID=this.sessionId,window.__CC_TRACKER_TOKEN=this.config.get("trackerToken")),this.logger.log("Session started:",this.sessionId),this.sessionId}getId(){return this.sessionId}end(){this.logger.log("Session ended:",this.sessionId),this.sessionId=null,this.config.set("sessionId",null)}isActive(){return null!==this.sessionId}}class o{constructor(e=!1){this.debug=e,this.prefix="CarbonCut:"}setDebug(e){this.debug=e}log(...e){this.debug&&console.log(this.prefix,...e)}warn(...e){this.debug&&console.warn(this.prefix,...e)}error(...e){console.error(this.prefix,...e)}info(...e){this.debug&&console.info(this.prefix,...e)}}class r{constructor(e,t){this.config=e,this.logger=t,this.queue=[],this.isOnline="undefined"==typeof navigator||navigator.onLine,"undefined"!=typeof window&&this.setupOnlineListener()}setupOnlineListener(){window.addEventListener("online",()=>{this.isOnline=!0,this.logger.log("Connection restored, flushing queue"),this.flushQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1,this.logger.warn("Connection lost, events will be queued")})}async send(e){if(!this.isOnline)return this.logger.warn("Offline, queueing event"),this.queue.push(e),!1;const t=this.config.get("apiUrl");try{if(this.shouldUseSendBeacon(e.event)){if(this.sendViaBeacon(t,e))return this.logger.log("Event sent via sendBeacon:",e.event),!0}const i=await this.sendViaFetch(t,e);return this.logger.log("Event sent via fetch:",e.event,"Status:",i.status),!0}catch(t){return this.logger.error("Failed to send event:",t),this.queue.push(e),!1}}sendViaBeacon(e,t){if("undefined"==typeof navigator||!navigator.sendBeacon)return!1;try{const i=new Blob([JSON.stringify(t)],{type:"application/json"});return navigator.sendBeacon(e,i)}catch(e){return this.logger.error("sendBeacon failed:",e),!1}}async sendViaFetch(e,t){e.endsWith("/")||(e+="/"),this.logger.log("Sending payload to:",e,t);const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-Tracker-Token":this.config.get("trackerToken")},body:JSON.stringify(t),keepalive:!0,redirect:"error"});if(202===i.status||200===i.status)return i;if(500!==i.status)throw new Error(`HTTP error! status: ${i.status}`);try{const e=await i.json();throw new Error(`API Error: ${e.message||"Unknown error"}`)}catch(e){throw new Error(`HTTP error! status: ${i.status}`)}}shouldUseSendBeacon(e){return["session_end","page_unload"].includes(e)}async flushQueue(){if(0===this.queue.length)return;this.logger.log(`Flushing ${this.queue.length} queued events`);const e=[...this.queue];this.queue=[];for(const t of e){await this.send(t)||this.queue.push(t)}}getQueueSize(){return this.queue.length}}class s{constructor(e,t){this.config=e,this.logger=t,this.worker=null,this.isSupported=this.checkWorkerSupport(),this.queueSize=0,this.isSupported?this.initWorker():this.logger.warn("Web Workers not supported, falling back to main thread")}checkWorkerSupport(){return"undefined"!=typeof Worker}initWorker(){try{const e=this.getWorkerCode(),t=new Blob([e],{type:"application/javascript"}),i=URL.createObjectURL(t);this.worker=new Worker(i),this.worker.addEventListener("message",e=>{this.handleWorkerMessage(e.data)}),this.worker.addEventListener("error",e=>{this.logger.error("Worker error:",e)}),this.worker.postMessage({type:"INIT",payload:{apiUrl:this.config.get("apiUrl"),trackerToken:this.config.get("trackerToken"),batchSize:10,batchInterval:5e3}}),this.setupOnlineListener(),this.logger.log("Web Worker initialized for v2 event processing")}catch(e){this.logger.error("Failed to initialize worker:",e),this.worker=null}}getWorkerCode(){return"\n      let config = null;\n      let eventQueue = [];\n      let flushTimer = null;\n      let isOnline = true;\n\n      self.addEventListener('message', async (event) => {\n        const { type, payload } = event.data;\n\n        switch (type) {\n          case 'INIT':\n            config = payload;\n            if (config.batchInterval) {\n              flushTimer = setInterval(() => {\n                if (eventQueue.length > 0) {\n                  flushQueue();\n                }\n              }, config.batchInterval);\n            }\n            self.postMessage({ type: 'INIT_SUCCESS' });\n            break;\n          \n          case 'TRACK_EVENT':\n            eventQueue.push({ ...payload, queuedAt: Date.now() });\n            if (eventQueue.length >= (config.batchSize || 10)) {\n              flushQueue();\n            }\n            break;\n          \n          case 'FLUSH_QUEUE':\n            await flushQueue();\n            break;\n          \n          case 'ONLINE':\n            isOnline = true;\n            await flushQueue();\n            break;\n          \n          case 'OFFLINE':\n            isOnline = false;\n            break;\n          \n          case 'GET_QUEUE_SIZE':\n            self.postMessage({ type: 'QUEUE_SIZE', size: eventQueue.length });\n            break;\n        }\n      });\n\n      async function flushQueue() {\n        if (eventQueue.length === 0 || !isOnline) return;\n        \n        const batch = [...eventQueue];\n        eventQueue = [];\n        \n        try {\n          // Send individual events\n          for (const event of batch) {\n            // Ensure URL always has trailing slash\n            let url = config.apiUrl;\n            if (!url.endsWith('/')) {\n              url = url + '/';\n            }\n            \n            const response = await fetch(url, {\n              method: 'POST',  // Explicitly set POST\n              headers: {\n                'Content-Type': 'application/json',\n                'X-Tracker-Token': config.trackerToken\n              },\n              body: JSON.stringify(event),\n              keepalive: true,\n              redirect: 'error'  // Don't follow redirects\n            });\n            \n            if (response.status !== 202 && response.status !== 200) {\n              throw new Error(`HTTP ${response.status}`);\n            }\n          }\n          \n          self.postMessage({ type: 'FLUSH_SUCCESS', count: batch.length });\n        } catch (error) {\n          eventQueue.push(...batch);\n          self.postMessage({ type: 'FLUSH_ERROR', error: error.message, count: batch.length });\n        }\n      }\n    "}handleWorkerMessage(e){const{type:t,count:i,error:n,size:o}=e;switch(t){case"INIT_SUCCESS":this.logger.log("Worker ready for v2 API");break;case"FLUSH_SUCCESS":this.logger.log(`Worker flushed ${i} v2 events`);break;case"FLUSH_ERROR":this.logger.error(`Worker flush failed: ${n}`);break;case"QUEUE_SIZE":this.queueSize=o}}setupOnlineListener(){window.addEventListener("online",()=>{this.worker?.postMessage({type:"ONLINE"})}),window.addEventListener("offline",()=>{this.worker?.postMessage({type:"OFFLINE"})})}async send(e){return this.worker?(this.worker.postMessage({type:"TRACK_EVENT",payload:e}),!0):this.sendDirect(e)}async sendDirect(e){try{return 202===(await fetch(this.config.get("apiUrl"),{method:"POST",headers:{"Content-Type":"application/json","X-Tracker-Token":this.config.get("trackerToken")},body:JSON.stringify(e),keepalive:!0})).status}catch(e){return this.logger.error("Direct send failed:",e),!1}}async flushQueue(){this.worker?.postMessage({type:"FLUSH_QUEUE"})}getQueueSize(){return this.worker?(this.worker.postMessage({type:"GET_QUEUE_SIZE"}),this.queueSize):0}terminate(){this.worker&&(this.worker.terminate(),this.worker=null,this.logger.log("Worker terminated"))}}function a(){if("undefined"==typeof window)return{utm_campaign:"",utm_source:"",utm_medium:"",utm_term:"",utm_content:""};const e=new URLSearchParams(window.location.search);return{utm_campaign:e.get("utm_campaign")||l("utm_campaign")||"",utm_source:e.get("utm_source")||l("utm_source")||"",utm_medium:e.get("utm_medium")||l("utm_medium")||"",utm_term:e.get("utm_term")||l("utm_term")||"",utm_content:e.get("utm_content")||l("utm_content")||""}}function c(e){"undefined"!=typeof window&&Object.entries(e).forEach(([e,t])=>{if(t&&"direct"!==t&&"none"!==t)try{sessionStorage.setItem(e,t)}catch(e){}})}function l(e){if("undefined"==typeof window)return null;try{return sessionStorage.getItem(e)}catch(e){return null}}class g{constructor(e){this.logger=e,this.lastCheckTime=Date.now(),this.pendingRequests=new Map}getPageViewBytes(){if("undefined"==typeof window||!window.performance)return null;try{const e=performance.getEntriesByType("navigation")[0];if(e)return{encodedBodySize:e.encodedBodySize||0,decodedBodySize:e.decodedBodySize||0,transferSize:e.transferSize||0,bytes:e.transferSize||0}}catch(e){this.logger.error("Error getting page view bytes:",e)}return null}getLatestTrackingRequestBytes(){if("undefined"==typeof window||!window.performance)return 0;try{const e=performance.getEntriesByType("resource").filter(e=>e.name.includes("/events")||e.name.includes("/api/v1")).sort((e,t)=>t.startTime-e.startTime);if(e.length>0){const t=e[0],i=t.transferSize||this.estimateGetRequestSize(t.name);return this.logger.log("üìä Latest tracking request bytes:",{url:t.name.substring(0,100)+"...",transferSize:t.transferSize,encodedBodySize:t.encodedBodySize,estimatedBytes:i}),i}}catch(e){this.logger.error("Error getting latest tracking request bytes:",e)}return 0}estimateGetRequestSize(e){return new Blob([e]).size+600}getRequestBytes(e){if("undefined"==typeof window||!window.performance)return null;try{const t=performance.getEntriesByType("resource").find(t=>t.name.includes(e));if(t)return{encodedBodySize:t.encodedBodySize||0,decodedBodySize:t.decodedBodySize||0,transferSize:t.transferSize||0,bytes:t.transferSize||0}}catch(e){this.logger.error("Error getting request bytes:",e)}return null}getResourcesBytesSince(e){if("undefined"==typeof window||!window.performance)return{total:0,count:0,byType:{}};try{const t=performance.getEntriesByType("resource").filter(t=>performance.timeOrigin+t.startTime>=e),i={};let n=0;return t.forEach(e=>{const t=e.initiatorType||"other",o=e.transferSize||this.estimateGetRequestSize(e.name);i[t]=(i[t]||0)+o,n+=o}),{total:n,count:t.length,byType:i}}catch(e){return this.logger.error("Error getting resources since timestamp:",e),{total:0,count:0,byType:{}}}}getAllResourceBytes(){if("undefined"==typeof window||!window.performance)return{total:0,byType:{}};try{const e=performance.getEntriesByType("resource"),t={};let i=0;return e.forEach(e=>{const n=e.initiatorType||"other",o=e.transferSize||0;t[n]=(t[n]||0)+o,i+=o}),{total:i,byType:t}}catch(e){return this.logger.error("Error getting resource bytes:",e),{total:0,byType:{}}}}observeTrackingBytes(e){if("undefined"==typeof PerformanceObserver)return this.logger.warn("PerformanceObserver not supported"),null;try{const t=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{if(t.name.includes("/events")||t.name.includes("api/v1")){const i=t.transferSize||this.estimateGetRequestSize(t.name);e({url:t.name,bytes:i,transferSize:t.transferSize,duration:t.duration,type:t.initiatorType})}})});return t.observe({entryTypes:["resource"]}),t}catch(e){return this.logger.error("Error setting up PerformanceObserver:",e),null}}getRequestByEventId(e){if("undefined"==typeof window||!window.performance)return null;try{const e=performance.getEntriesByType("resource").filter(e=>e.name.includes("/events")||e.name.includes("api/v1"));if(e.length>0){const t=e[e.length-1];return{bytes:t.transferSize||this.estimateGetRequestSize(t.name),encoded:t.encodedBodySize||0,decoded:t.decodedBodySize||0,transferSize:t.transferSize}}}catch(e){this.logger.error("Error getting request by event ID:",e)}return null}}class u{constructor(e){this.logger=e,this.cacheKey="cc_geolocation_cache",this.cacheExpiry=36e5,this.cachedLocation=null,this.isRequesting=!1,console.log("CarbonCut: üìç GeolocationManager initialized",{cacheKey:this.cacheKey,cacheExpiry:this.cacheExpiry/1e3/60+" minutes"})}getCachedLocation(){if("undefined"==typeof localStorage)return this.logger.warn("üìç localStorage not available"),null;try{const e=localStorage.getItem(this.cacheKey);if(!e)return this.logger.log("üìç No cached location found"),null;const{location:t,timestamp:i}=JSON.parse(e),n=Date.now(),o=Math.floor((n-i)/1e3/60);return this.logger.log("üìç Cached location found:",{location:t,cachedAt:new Date(i).toISOString(),ageMinutes:o,expiresInMinutes:Math.floor((this.cacheExpiry-(n-i))/1e3/60)}),n-i<this.cacheExpiry?(this.logger.log("Using cached geolocation (still valid)"),t):(this.logger.log("Geolocation cache expired, removing"),localStorage.removeItem(this.cacheKey),null)}catch(e){return this.logger.error("‚ùå Error reading cached location:",e),null}}cacheLocation(e){if("undefined"!=typeof localStorage)try{const t={location:e,timestamp:Date.now()};localStorage.setItem(this.cacheKey,JSON.stringify(t)),this.logger.log("üíæ Geolocation cached successfully:",{location:e,cachedAt:new Date(t.timestamp).toISOString(),expiresAt:new Date(t.timestamp+this.cacheExpiry).toISOString()})}catch(e){this.logger.error("‚ùå Error caching location:",e)}else this.logger.warn("üìç localStorage not available, cannot cache")}async getCurrentLocation(e={}){console.log("CarbonCut: üìç Requesting geolocation with options:",e);const t=this.getCachedLocation();if(t)return console.log("CarbonCut:   Using cached location:",{latitude:t.latitude.toFixed(6),longitude:t.longitude.toFixed(6),accuracy:`${Math.round(t.accuracy)}m`}),t;if(this.isRequesting)return console.warn("CarbonCut: ‚ö†Ô∏è Geolocation request already in progress"),null;if("undefined"==typeof navigator||!navigator.geolocation)return console.warn("CarbonCut: ‚ùå Geolocation is not supported by this browser"),null;this.isRequesting=!0,console.log("CarbonCut: üåç Requesting fresh geolocation from browser...");const i={enableHighAccuracy:!1,timeout:1e4,maximumAge:0,...e};try{const e=Date.now(),t=await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,i)}),n=Date.now()-e,o={latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,timestamp:t.timestamp,altitude:t.coords.altitude,altitudeAccuracy:t.coords.altitudeAccuracy,heading:t.coords.heading,speed:t.coords.speed};return console.log("CarbonCut:   Geolocation obtained successfully:",{latitude:o.latitude.toFixed(6),longitude:o.longitude.toFixed(6),accuracy:`${Math.round(o.accuracy)}m`,requestDuration:`${n}ms`,timestamp:new Date(t.timestamp).toISOString()}),this.cacheLocation(o),this.cachedLocation=o,this.isRequesting=!1,o}catch(e){const t=Date.now()-startTime;this.isRequesting=!1;const i={errorCode:e.code,errorMessage:e.message,requestDuration:`${t}ms`,timestamp:(new Date).toISOString()};switch(e.code){case e.PERMISSION_DENIED:console.warn("CarbonCut: ‚ùå Geolocation permission denied by user",i);break;case e.POSITION_UNAVAILABLE:console.warn("CarbonCut: ‚ùå Geolocation position unavailable",i);break;case e.TIMEOUT:console.warn("CarbonCut: ‚è±Ô∏è Geolocation request timed out",i);break;default:console.error("CarbonCut: ‚ùå Geolocation error:",e,i)}return null}}clearCache(){if("undefined"!=typeof localStorage)try{const e=null!==localStorage.getItem(this.cacheKey);localStorage.removeItem(this.cacheKey),this.cachedLocation=null,this.logger.log("üóëÔ∏è Geolocation cache cleared",{hadCache:e,timestamp:(new Date).toISOString()})}catch(e){this.logger.error("‚ùå Error clearing location cache:",e)}else this.logger.warn("üìç localStorage not available")}async checkPermission(){if("undefined"==typeof navigator||!navigator.permissions)return this.logger.warn("‚ùå Permissions API not available"),!1;try{const e=await navigator.permissions.query({name:"geolocation"});return this.logger.log("üîê Geolocation permission status:",{state:e.state,timestamp:(new Date).toISOString()}),"granted"===e.state}catch(e){return this.logger.error("‚ùå Error checking geolocation permission:",e),!1}}getCacheStatus(){if("undefined"==typeof localStorage)return{hasCache:!1,reason:"localStorage not available"};try{const e=localStorage.getItem(this.cacheKey);if(!e)return{hasCache:!1,reason:"No cache found"};const{location:t,timestamp:i}=JSON.parse(e),n=Date.now(),o=Math.floor((n-i)/1e3/60),r=n-i<this.cacheExpiry,s={hasCache:!0,isValid:r,location:t,cachedAt:new Date(i).toISOString(),ageMinutes:o,expiresInMinutes:r?Math.floor((this.cacheExpiry-(n-i))/1e3/60):0};return this.logger.log("üìä Cache status:",s),s}catch(e){return this.logger.error("‚ùå Error getting cache status:",e),{hasCache:!1,reason:"Error reading cache",error:e.message}}}}class h{constructor(e,t,i,n){this.config=e,this.session=t,this.transport=i,this.logger=n,this.sentEvents=new Map,this.utmParams=null,this.conversionRulesApplied=!1,this.performanceMonitor=new g(n),this.geolocationManager=new u(n),this.bytesTracked={pageView:0,clicks:0,conversions:0,total:0},this.lastEventTime=Date.now(),this.initializeUTMParams(),this.setupPerformanceTracking()}initializeUTMParams(){this.utmParams=a(),c(this.utmParams),this.logger.log("UTM parameters initialized:",this.utmParams)}setupPerformanceTracking(){this.performanceObserver=this.performanceMonitor.observeTrackingBytes(e=>{this.logger.log("üìä Tracking request bytes:",e),e.url.includes("page_view")?this.bytesTracked.pageView+=e.bytes:e.url.includes("click")?this.bytesTracked.clicks+=e.bytes:e.url.includes("conversion")&&(this.bytesTracked.conversions+=e.bytes),this.bytesTracked.total+=e.bytes})}async getTrackingRequestBytes(e){await new Promise(e=>setTimeout(e,100));const t=this.performanceMonitor.getRequestByEventId(e);return t?.bytes||0}estimateRequestSize(e){const t=JSON.stringify(e),i=new Blob([t]).size;return{bodyBytes:i,estimatedTotal:i+850,actualJson:t}}async getGeolocationData(){const e=this.config.get("enableGeolocation"),t=this.config.get("requestLocation");if(this.logger.log("üìç Geolocation configuration:",{enableGeolocation:e,requestLocation:t,timeout:this.config.get("geolocationTimeout"),highAccuracy:this.config.get("geolocationHighAccuracy")}),!e&&!t)return this.logger.log("üìç Geolocation disabled, skipping"),null;const i=this.geolocationManager.getCacheStatus();this.logger.log("üìç Cache status before request:",i);try{const e=await this.geolocationManager.getCurrentLocation({enableHighAccuracy:this.config.get("geolocationHighAccuracy"),timeout:this.config.get("geolocationTimeout")});return e?this.logger.log("  Geolocation data ready for event:",{latitude:e.latitude.toFixed(6),longitude:e.longitude.toFixed(6),accuracy:`${Math.round(e.accuracy)}m`,fromCache:i.isValid,timestamp:new Date(e.timestamp).toISOString()}):this.logger.warn("‚ö†Ô∏è Geolocation returned null"),e}catch(e){return this.logger.error("‚ùå Failed to get geolocation:",e),null}}async send(e,t={}){if(!this.session.isActive())return void this.logger.error("Cannot send event without active session");const i={session_start:"page_view",page_view:"page_view",ping:"page_view",custom_event:"click",session_end:"conversion",button_click:"click",form_submit:"conversion",conversion:"conversion"}[e]||"click",n="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"evt_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);let o={};if("session_start"===e){const e=this.performanceMonitor.getPageViewBytes();e&&(o={bytesPerPageView:e.transferSize,encodedSize:e.encodedBodySize,decodedSize:e.decodedBodySize,resourceType:"navigation"})}else{const t=this.performanceMonitor.getResourcesBytesSince(this.lastEventTime);o={resourceCount:t.count,resourceTypes:t.byType,resourceType:"dynamic"},"page_view"===e||"ping"===e?o.bytesPerPageView=t.total:"button_click"===e||"click"===i?o.bytesPerClick=t.total:"conversion"===i&&(o.bytesPerConversion=t.total)}let r=null;"session_start"!==e&&"conversion"!==e||(r=await this.getGeolocationData());const s={event:i,session_id:this.session.getId(),timestamp:(new Date).toISOString(),tracker_token:this.config.get("trackerToken"),utm_params:this.utmParams,event_id:n,user_id:t.user_id||this.session.getId(),page_url:"undefined"!=typeof window?window.location.href:t.page_url||"",referrer:"undefined"!=typeof document?document.referrer:t.referrer||"",...o,...r&&{geolocation:r,latitude:r.latitude,longitude:r.longitude,location_accuracy:r.accuracy},...t},a=this.estimateRequestSize(s);s.trackingRequestBytes=a.estimatedTotal,s.trackingRequestBody=a.bodyBytes;const c=`${e}_${s.timestamp}_${JSON.stringify(t)}`;this.sentEvents.has(c)?this.logger.warn("Duplicate event prevented:",e):(this.sentEvents.set(c,Date.now()),setTimeout(()=>{this.sentEvents.delete(c)},2e3),this.logger.log("üì§ Sending event with performance data:",{event:i,bytes:o,requestSize:a.estimatedTotal,hasGeolocation:!!r}),this.transport.send(s),setTimeout(()=>{this.lastEventTime=Date.now();const t=this.performanceMonitor.getLatestTrackingRequestBytes();t>0&&this.logger.log(`  Captured ${t} bytes for ${e} event`)},100),"page_view"!==e&&"session_start"!==e||this.checkUrlConversions())}trackCustomEvent(e,t={}){this.send("custom_event",{event_name:e,event_data:t,custom_event_type:e,...t}),this.logger.log("Custom event tracked:",e)}refreshUTMParams(){this.utmParams=a(),c(this.utmParams),this.logger.log("UTM parameters refreshed:",this.utmParams)}applyConversionRules(){const e=this.config.get("conversionRules")||[];e.length?(this.logger.log(`üìã Applying ${e.length} conversion rules`),e.forEach(e=>{"click"===e.type&&this.trackClickConversion(e)}),this.checkUrlConversions(),this.conversionRulesApplied=!0):this.logger.warn("No conversion rules found. Skipping conversion tracking.")}checkUrlConversions(){const e=(this.config.get("conversionRules")||[]).filter(e=>"url"===e.type);if(0===e.length)return;const t=window.location.href,i=window.location.pathname;this.logger.log("üîç Checking URL conversions for:",i),e.forEach(e=>{let n=!1;const o=e.pattern;switch(e.match_type){case"contains":n=t.includes(o)||i.includes(o);break;case"exact":n=t===o||i===o;break;case"starts_with":n=t.startsWith(o)||i.startsWith(o);break;case"ends_with":n=t.endsWith(o)||i.endsWith(o);break;case"regex":try{const e=new RegExp(o);n=e.test(t)||e.test(i)}catch(e){this.logger.error("Invalid regex pattern:",o,e)}}n&&(this.logger.log("üéØ URL conversion matched:",e),this.send("conversion",{conversion_type:"url",conversion_label:e.name,conversion_url:t,conversion_rule_id:e.id,match_type:e.match_type,pattern:o}))})}trackUrlConversion(e){this.logger.warn("trackUrlConversion is deprecated, use checkUrlConversions instead")}trackClickConversion(e){this.logger.log("Setting up click conversion listener for:",e.selector),document.addEventListener("click",t=>{const i=t.target.closest(e.selector);i&&(this.logger.log("üéØ Click conversion matched:",e),this.send("conversion",{conversion_type:"click",conversion_label:e.name,conversion_selector:e.selector,conversion_element:i.tagName,conversion_rule_id:e.id,element_text:i.innerText?.substring(0,100)}))})}getBytesTracked(){return{...this.bytesTracked,total:Object.values(this.bytesTracked).reduce((e,t)=>e+t,0)}}async requestUserLocation(){this.logger.log("üìç Manual location request initiated");const e=await this.geolocationManager.checkPermission();this.logger.log("üìç Current permission status:",e?"granted":"not granted");const t=await this.geolocationManager.getCurrentLocation();return t?(this.logger.log("  Manual location request successful:",{latitude:t.latitude.toFixed(6),longitude:t.longitude.toFixed(6),accuracy:`${Math.round(t.accuracy)}m`}),t):(this.logger.warn("‚ùå Manual location request failed"),null)}clearLocationCache(){this.logger.log("üóëÔ∏è Clearing location cache..."),this.geolocationManager.clearCache()}}class d{constructor(e,t,i,n){this.config=e,this.state=t,this.eventTracker=i,this.logger=n,this.timer=null}start(){this.stop();const e=this.config.get("pingInterval");this.timer=setInterval(()=>{const t=e/1e3;this.state.incrementTimeSpent(t),this.ping()},e),this.logger.log(`Ping timer started. Interval: ${e/1e3}s`)}stop(){this.timer&&(clearInterval(this.timer),this.timer=null,this.logger.log("Ping timer stopped"))}ping(){this.eventTracker.send("ping",{time_spent_seconds:this.state.get("timeSpent"),page_url:"undefined"!=typeof window?window.location.href:null,is_visible:"undefined"==typeof document||!document.hidden})}trigger(){this.ping()}isRunning(){return null!==this.timer}}class p{constructor(e,t,i,n){this.config=e,this.state=t,this.eventTracker=i,this.logger=n}track(e){const t="undefined"==typeof window||"undefined"==typeof document?{}:{page_path:window.location.pathname,page_url:window.location.href,page_title:document.title,referrer:document.referrer};e&&(t.page_path=e),this.eventTracker.send("page_view",t),this.state.set("lastPath",t.page_path),this.logger.log("Page view tracked:",t.page_path)}}class f{constructor(e,t,i,n,o,r,s){this.config=e,this.state=t,this.session=i,this.eventTracker=n,this.pingTracker=o,this.pageViewTracker=r,this.logger=s}setup(){"undefined"!=typeof window&&(this.setupUnloadListener(),this.setupVisibilityListener(),this.setupClickTracking(),this.config.get("autoTrack")&&this.setupNavigationListeners())}setupUnloadListener(){window.addEventListener("beforeunload",()=>{this.pingTracker.stop(),this.eventTracker.send("session_end",{total_time_spent_seconds:this.state.get("timeSpent"),page_url:window.location.href}),this.session.end()})}setupVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?(this.pingTracker.stop(),this.logger.log("Page hidden, ping timer paused")):(this.pingTracker.start(),this.logger.log("Page visible, ping timer resumed"))})}setupClickTracking(){document.addEventListener("click",e=>{const t=e.target,i={tag:t.tagName.toLowerCase(),id:t.id||null,class:t.className||null,text:t.innerText?.substring(0,100)||null,href:t.href||null};"BUTTON"===t.tagName||t.closest("button")?(this.eventTracker.send("button_click",{...i,button_type:t.type||"button"}),this.logger.log("Button click tracked:",i)):"A"===t.tagName||t.closest("a")?(this.eventTracker.send("custom_event",{event_name:"link_click",...i,external:t.hostname!==window.location.hostname}),this.logger.log("Link click tracked:",i)):"INPUT"===t.tagName&&"submit"===t.type&&(this.eventTracker.send("form_submit",{...i,form_id:t.form?.id||null,form_name:t.form?.name||null}),this.logger.log("Form submit tracked:",i))},!0),this.logger.log("Automatic click tracking enabled")}setupNavigationListeners(){this.state.set("lastPath",window.location.pathname);const e=()=>{const e=window.location.pathname;e!==this.state.get("lastPath")&&this.pageViewTracker.track(e)};window.addEventListener("popstate",e);const t=history.pushState,i=history.replaceState;history.pushState=function(){t.apply(this,arguments),e()},history.replaceState=function(){i.apply(this,arguments),e()},this.logger.log("SPA navigation tracking enabled")}}const m=new class{constructor(){this.logger=new o(!1),this.config=new t,this.state=new i,this.session=null,this.transport=null,this.eventTracker=null,this.pingTracker=null,this.pageViewTracker=null,this.browserListeners=null,this.autoInitAttempted=!1,this.conversionRules=[]}normalizeDomain(e){return e?e.toLowerCase().replace(/\/+$/,""):""}getScriptConfig(){if("undefined"==typeof document)return null;const e=document.getElementsByTagName("script");let t=null;for(let i of e){const e=i.getAttribute("src");if(e&&(e.includes("carboncut.min.js")||e.includes("carboncut.js"))){let e=i.getAttribute("data-api-url")||"http://127.0.0.1:8000/api/v1/events/";e.endsWith("/")||(e+="/"),t={trackerToken:i.getAttribute("data-token")||i.getAttribute("data-tracker-token"),apiUrl:e,debug:"true"===i.getAttribute("data-debug"),domain:i.getAttribute("data-domain")||window.location.origin,useWorker:"false"!==i.getAttribute("data-use-worker"),enableGeolocation:"true"===i.getAttribute("data-enable-geolocation"),requestLocation:"true"===i.getAttribute("data-request-location"),promptForLocationOnLoad:"false"!==i.getAttribute("data-prompt-for-location-on-load")};break}}return t}async fetchConversionRules(){const e=this.config.get("apiUrl"),t=this.config.get("trackerToken");if(!t)return this.logger.error("Tracker token is missing. Cannot fetch conversion rules."),!1;try{const i=`${e.replace("/events/","/keys/config")}?api_key=${t}`;this.logger.log("Fetching conversion rules from:",i);const n=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to fetch conversion rules: ${n.status} ${n.statusText}`);const o=await n.json();if(!o.success)return this.logger.error("Invalid API key:",t),!1;const r=this.normalizeDomain(window.location.origin),s=this.normalizeDomain(o.domain);return this.logger.log("üîç Domain validation:"),this.logger.log("   - Current domain:",r),this.logger.log("   - Configured domain:",s),s&&"*"!==s&&s!==r?(this.logger.error(`‚ùå Invalid domain. Configured domain (${s}) does not match the current domain (${r}).`),!1):("*"===s?this.logger.log("Wildcard domain (*) - allowing all domains"):this.logger.log("Domain validation passed"),this.conversionRules=o.conversion_rules||[],this.config.set("conversionRules",this.conversionRules),this.logger.log("Fetched conversion rules:",this.conversionRules),this.eventTracker&&this.conversionRules.length>0&&this.eventTracker.applyConversionRules(),!0)}catch(e){return this.logger.error("Error fetching conversion rules:",e),!1}}autoInit(){if(this.autoInitAttempted||this.isInitializing)return void this.logger.warn("Auto-init already attempted or in progress");this.autoInitAttempted=!0,this.isInitializing=!0;const e=this.getScriptConfig();if(!e||!e.trackerToken)return console.error("CarbonCut: No tracker token found. Add data-token attribute to script tag."),void(this.isInitializing=!1);this.init(e),this.isInitializing=!1}async init(e={}){if("undefined"==typeof window||"undefined"==typeof document)return this.logger.error("CarbonCut SDK can only be initialized in a browser environment"),!1;if(this.state.get("isInitialized"))return this.logger.warn("CarbonCut is already initialized"),!1;if(!this.config.init(e))return!1;if(this.logger.setDebug(this.config.get("debug")),this.config.get("respectDoNotTrack")&&"1"===navigator.doNotTrack)return this.logger.warn("Do Not Track is enabled, tracking disabled"),!1;if(!await this.fetchConversionRules())return this.logger.error("Initialization aborted due to invalid API key or domain."),!1;this.session=new n(this.config,this.logger);const t=!1!==this.config.get("useWorker");return t&&"undefined"!=typeof Worker?(this.transport=new s(this.config,this.logger),this.logger.log("Using Web Worker for v2 event processing")):(this.transport=new r(this.config,this.logger),this.logger.log("Using main thread for v2 event processing")),this.eventTracker=new h(this.config,this.session,this.transport,this.logger),this.pingTracker=new d(this.config,this.state,this.eventTracker,this.logger),this.pageViewTracker=new p(this.config,this.state,this.eventTracker,this.logger),this.browserListeners=new f(this.config,this.state,this.session,this.eventTracker,this.pingTracker,this.pageViewTracker,this.logger),this.session.start(),this.eventTracker.send("session_start","undefined"==typeof window||"undefined"==typeof document?{}:{user_agent:navigator.userAgent,screen_resolution:`${window.screen.width}x${window.screen.height}`,viewport_size:`${window.innerWidth}x${window.innerHeight}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,referrer:document.referrer||"direct",page_url:window.location.href,page_title:document.title}),this.pingTracker.start(),this.browserListeners.setup(),this.state.set("isInitialized",!0),this.logger.log("CarbonCut SDK v2 initialized successfully",{sessionId:this.session.getId(),trackerToken:this.config.get("trackerToken"),workerEnabled:t,apiVersion:"v2"}),this.config.get("promptForLocationOnLoad")&&(this.logger.log("üìç SDK: `promptForLocationOnLoad` is true, requesting location..."),this.config.set("enableGeolocation",!0),setTimeout(async()=>{const e=await this.eventTracker.requestUserLocation();e&&this.logger.log("  SDK: Initial geolocation obtained on load:",{latitude:e.latitude.toFixed(6),longitude:e.longitude.toFixed(6),accuracy:`${Math.round(e.accuracy)}m`})},500)),!0}trackEvent(e,t={}){this.state.get("isInitialized")?this.eventTracker.trackCustomEvent(e,t):this.logger.error("SDK not initialized. Call init() first")}trackPageView(e){this.state.get("isInitialized")?this.pageViewTracker.track(e):this.logger.error("SDK not initialized. Call init() first")}ping(){this.state.get("isInitialized")?this.pingTracker.trigger():this.logger.error("SDK not initialized. Call init() first")}async requestLocation(){if(!this.state.get("isInitialized"))return this.logger.error("SDK not initialized. Call init() first"),null;this.logger.log("üìç SDK: Manually requesting user location"),this.logger.log("üìç SDK: Current geolocation settings:",{enabled:this.config.get("enableGeolocation"),requestLocation:this.config.get("requestLocation"),timeout:this.config.get("geolocationTimeout"),highAccuracy:this.config.get("geolocationHighAccuracy")});const e=await this.eventTracker.requestUserLocation();return e?this.logger.log("  SDK: Location obtained successfully"):this.logger.warn("‚ö†Ô∏è SDK: Failed to obtain location"),e}async enableGeolocation(){if(this.config.set("enableGeolocation",!0),this.logger.log("  SDK: Geolocation tracking enabled"),this.state.get("isInitialized")&&this.eventTracker){this.logger.log("üìç SDK: Auto-requesting location after enabling geolocation");const e=await this.eventTracker.requestUserLocation();return e&&this.logger.log("  SDK: Geolocation obtained and cached:",{latitude:e.latitude.toFixed(6),longitude:e.longitude.toFixed(6),accuracy:`${Math.round(e.accuracy)}m`}),e}return null}disableGeolocation(){this.config.set("enableGeolocation",!1),this.eventTracker?.clearLocationCache(),this.logger.log("üö´ SDK: Geolocation tracking disabled")}getGeolocationStatus(){if(!this.eventTracker?.geolocationManager)return{enabled:!1,reason:"SDK not initialized"};const e={enabled:this.config.get("enableGeolocation"),requestLocation:this.config.get("requestLocation"),cacheStatus:this.eventTracker.geolocationManager.getCacheStatus(),config:{timeout:this.config.get("geolocationTimeout"),highAccuracy:this.config.get("geolocationHighAccuracy")}};return this.logger.log("üìç Geolocation status:",e),e}getSessionInfo(){return{sessionId:this.session?.getId()||null,trackerToken:this.config.get("trackerToken"),timeSpent:this.state.get("timeSpent"),isInitialized:this.state.get("isInitialized"),queueSize:this.transport?.getQueueSize()||0,apiVersion:"v2",utmParams:this.eventTracker?.utmParams||null,conversionRules:this.conversionRules,geolocationEnabled:this.config.get("enableGeolocation")}}enableDebug(){this.logger.setDebug(!0),this.config.set("debug",!0)}disableDebug(){this.logger.setDebug(!1),this.config.set("debug",!1)}destroy(){this.pingTracker?.stop(),this.transport?.terminate?.(),this.session?.end(),this.state.reset(),this.logger.log("SDK destroyed")}};return"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{m.autoInit()},{once:!0}):m.autoInit()),"undefined"!=typeof module&&module.exports&&(module.exports=m),"undefined"!=typeof window&&(window.CarbonCut=m),m}();
//# sourceMappingURL=carboncut.min.js.map
